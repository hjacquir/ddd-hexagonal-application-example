# DDD-hexagonal-application-example

## Best practices

### Doctrine migrations
* always use IDEMPOTENCE : see \DoctrineMigrations\Version20230607063630
* do not add migration class manually : use `diff` or `generate` command
* after a `migrate` always do a `diff` to see if changes exists and fix them

### DDD and Hexagonal choices for modelling
* The `src/Domain/Model and Repository ` contains only Interface and the `src/Infrastructure/Doctrine/Entity and Repository` 
contains the concrete classes and persisted entity : to separate Domain and Infrastructure

## Description

This project is an example of hexagonal architecture with an DDD (Domain Driven Design) application on a use case. 

### More information about hexagonal architecture

https://en.wikipedia.org/wiki/Hexagonal_architecture_(software)

## Context schema

![](schema.png)

## Use case

Implement a REST API in PHP which makes it possible to query the presence of a keyword among
the commits messages of a given day on [GH Archive] (https://www.gharchive.org /).
For example a curve of the number of commits during the day of 2018-01-01 which have the keyword "fix".

### Features

* Implement a command line client to download the archives for
  a given day and store them in the database.

* Expose an API allowing to query the database using a keyword and a date.

### Scenario

```Gherkin
When I enter a date and a keyword
Then for the search criteria entered the total number of events is displayed
And the total number by type of event is displayed
And the total number by type of events per hour is displayed
And the last 5 commits are visible
```

## Use development environment :computer:

You only need `make`, `docker` and `docker-compose` installed to start the development environment.

### Stack

* PHP 8.1
* Symfony 5.4 with Profiler Pack : symfony/profiler-pack
* API Platform
* RabbitMQ 3.6
* Adminer 4.7
* PostgreSQL 13
* Redis

#### Connect to RabbitMQ

* url : http://localhost:15672
* id/mdp : guest/guest

#### Connect to Adminer

* url : http://localhost:8080/
* server : postgres
* username : user
* password: password
* database : app

### Connect to redis container

`docker exec -it app_redis sh` and `redis-cli`

### Start the development environment

The following command will start the development environment.
You can access to the application at http://127.0.0.1:8000/ :

```bash
make start
```

### Access to a shell in the PHP container

```bash
make shell
```

### Tests tools

You can run PHPUnit with the following command:
```bash
# Run the unit test suite
make unit-test

# Run the functionnal test suite
make func-test
```

### Stop the development environment

You can stop the development environment running this command:
```bash
make stop
```

### Clean the development environment

You can clean the development environment (docker images, vendor, ...) running this command:
```bash
make clean
```

### Makefile targets

You can get available targets by running:
```bash
make
```

```bash
build                          Build the docker stack
pull                           Pulling docker images
shell                          Enter in the PHP container
start                          Start the docker stack
stop                           Stop the docker stack
clean                          Clean the docker stack
vendor                         Install composer dependencies
unit-test                      Run PhpUnit unit testsuite
func-test                      Run PhpUnit functionnal testsuite
```

### Code style

The project follows the PSR12 standard.

## Usage

### Update database

Execute doctrine migrations : `make shell` and `bin/console d:m:m`

### Download Github archive remote file

* Define in your .env.local configuration file the path to the directory that will store the downloaded archive files :
  `LOCAL_DOWNLOADED_FILE_PATH`
* Enter in your shell (`make shell`) and launch the command : `bin/console app:download 2014-02-01 0 1` with the date to fetch (e.g : 2012-02-02 here)
  to verbose all log message add the options : `-vvv` like `bin/console app:download 2014-02-01 0 1 -vvv`. Arguments (all are required): 
  * The date to fetch
  * The time of the first file to download (between 0 and 23)
  * The time of the last file to download (between 0 and 23)
* The files are downloaded into the local folder and a message was sent to rabbitmq with the filename

### Extract downloaded file

* The files are extracted by consuming amqp message : `bin/console messenger:consume downloaded -vvv`
* The files are extracted in the same folder

### Map or transform event

* The github event are mapped by consuming extracted file : `bin/console messenger:consume extracted -vvv`

### Load event

* The github event are loaded in db by consuming mapped event data : `bin/console messenger:consume mapped -vvv`

### Api

* The API doc generated by Nelmio API doc bundle is here : http://127.0.0.1:8000/api/docs
